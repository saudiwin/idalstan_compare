# Test file to show how package works

# Import latest senate data using pscl
require(pscl)
require(dplyr)
require(idealstan)
require(tidyr)
require(ggplot2)
require(bayesplot)
require(readr)
require(wnominate)

set.seed(84520)
data('senate114')

newdata <- senate114

# let's see what pscl/dwnominate do with the data
estimate_it <- FALSE
# priors for pscl model to identify the model

cl <- constrain.legis(newdata,
                      x=list('SASSE (R NE)'=1,
                             'SANDERS (Indep VT)'=-1))

pscl_model <- ideal(newdata,store.item=TRUE,normalize = T,
                    dropList=list(codes='notInLegis',lop=0.0,
                                   legisMin=20),
                    maxiter=30000,
                    burnin=20000)
  wnominate_model <- wnominate(newdata,polarity='SASSE (R NE)',dims=1,trials=10)
# we can compare models directly by forming an idealstan object out of pscl_model

pscl_pts <- data_frame(ideal_pts=apply(pscl_model$x,2,median)*-1,
                       high_pt=apply(pscl_model$x,2,quantile,probs=0.95)*-1,
                       low_pt=apply(pscl_model$x,2,quantile,probs=0.05)*-1,
                       model_type='CJR')
wnominate_pts <- data_frame(ideal_pts=wnominate_model$legislators$coord1D,
                            high_pt=wnominate_model$legislators$coord1D + 1.96*wnominate_model$legislators$se1D,
                            low_pt=wnominate_model$legislators$coord1D - 1.96*wnominate_model$legislators$se1D,
                            model_type='W-NOMINATE')

# now run idealstan
newdata <- senate114
to_use <- newdata$votes[-1, ]
newdata$legis.data <- newdata$legis.data[-1, ]
to_use <- apply(to_use, 2, function(x) {
  y <- recode(
    x,
    `1` = 2L,
    `6` = 1L,
    `9` = 3L
  )
  return(y)
})

rownames(to_use) <- rownames(newdata$legis.data)

idealdata <-
  id_make(
    vote_data = to_use,
    legis_data = newdata$legis.data,
    abs_vote = 3,
    yes_vote = 2,
    no_vote = 1,
    ordinal = F,
    exclude_level = 7
  )
#,which(row.names(to_use)=='SANDERS (Indep VT)')
if(estimate_it==TRUE) {
  estimated_full <-
    id_estimate(idealdata = idealdata,
                model_type = 2,
                use_vb = F,
                ncores=4,
                nfix=2,
                restrict_type='constrain_twoway',
                restrict_params='legis',
                restrict_ind_high = c(which(row.names(to_use)=='SASSE (R NE)'),
                                      which(row.names(to_use)=='CRUZ (R TX)'),
                                      which(row.names(to_use)=='RUBIO (R FL)')),
                restrict_ind_low=c(which(row.names(to_use)=='SANDERS (Indep VT)'),
                                   which(row.names(to_use)=='REID (D NV)'),
                                   which(row.names(to_use)=='WARREN (D MA)')),
                auto_id=F,
                fixtype='constrained',
                #pin_vals=c(1),
                abs_discrim_sd = 5,
                reg_discrim_sd = 5,
                legis_sd = 1,
                diff_sd=5,
                seed=84520)
  saveRDS(estimated_full,'senate_104_absence_inf.rds')  
} else {
  estimated_full <- readRDS('senate_104_absence_inf.rds')
}

output <- rstan::extract(estimated_full@stan_samples)
abs_pts <- data_frame(ideal_pts=apply(output$L_full,3,median),
                         high_pt=apply(output$L_full,3,quantile,probs=0.95),
                         low_pt=apply(output$L_full,3,quantile,probs=0.05),
                         model_type='Absence-Inflated',
                      row_id=as.numeric(row.names(estimated_full@vote_data@vote_matrix))) %>% 
                        arrange(row_id) %>% 
  mutate(ranks=1)

all_perf <- bind_rows(pscl_pts,slice(wnominate_pts,-1),abs_pts) %>% 
  mutate(legislators=rep(row.names(wnominate_model$legislators)[-1],3)) %>% 
  group_by(model_type) %>% 
  mutate(ideal_pts_std=(ideal_pts/sd(ideal_pts))-mean(ideal_pts),
         high_pt_std=high_pt/sd(ideal_pts)-mean(ideal_pts),
         low_pt_std=low_pt/sd(ideal_pts)-mean(ideal_pts)) %>% 
  arrange(desc(ideal_pts)) %>% 
  mutate(ranks=1:n())

all_perf %>% 
  ggplot((aes(y=ideal_pts_std,ymin=low_pt_std,ymax=high_pt_std))) +
  geom_pointrange(aes(color=model_type,x=reorder(legislators,ideal_pts)),position=position_dodge(width=0.3),
                  size=0.15) + 
  coord_flip() + theme_minimal() +
  theme(panel.grid = element_blank()) +
  ylab('Ideal Point Scores (Liberal to Conservative)') +
  xlab('') +
  scale_colour_brewer(palette='Accent',name="")
  
ggsave('all_perf.png',width=7,height=10,scale=1.1,units='in')


# Identify those legislators who show biggest discrepancies.

big_diff <- group_by(all_perf,legislators) %>% arrange(legislators,model_type) %>% 
  mutate(total_diff=if_else(max(abs(ranks[2]-ranks[1]))>max(abs(ranks[3]-ranks[1])),
                            ranks[2]-ranks[1],ranks[3]-ranks[1])) %>% 
    ungroup() %>% 
           arrange(desc(abs(total_diff))) %>% 
           slice(1:30) %>% 
  group_by(legislators) %>% 
  mutate(labels=ifelse(sample(1:3,size = 1)==model_type,legislators,NA)) %>% 
  ungroup %>% 
         mutate(legislators=factor(legislators,levels=unique(legislators)),
                rank_labels=if_else(total_diff>0,paste0('Rank +',as.integer(total_diff)),
                                    paste0('Rank ',as.integer(total_diff))),
                rank_labels=if_else(model_type=='CJR',rank_labels,''))
          
big_diff %>% ggplot((aes(y=ideal_pts_std,ymin=low_pt_std,ymax=high_pt_std))) +
  geom_pointrange(aes(color=model_type,shape=model_type,x=factor(legislators)),fill=NA,position=position_dodge(width=.5),
                  size=0.5) + 
  theme_minimal() +
  theme(panel.grid = element_blank(),
        axis.text.x=element_text(angle=90,hjust=1)) +
  xlab('Positive Rank Changes Indicate More Conservative and Vice Versa') +
  ylab('') + 
  geom_text(aes(label=rank_labels,x=legislators,
                y=ideal_pts*2.5)) +
  scale_colour_brewer(palette='Set1',name="") +
  guides(shape='none')

ggsave('big_diff.png',width=10,height=5,units='in',scale=1.1)

# Now we want to look at the bill pts
require(readr)
bills_data <- read_csv('rollcall_senate_114.csv') %>% 
  mutate(vote_id=paste0('Vote_',1:n()),bill_num=1:n())
bills <- as_data_frame(output$sigma_abs_full)
names(bills) <- paste0('Vote_',1:ncol(bills))

bills <- mutate(bills,iter=1:n()) %>% gather(bill_name,estimate,-iter) %>% 
  left_join(bills_data,by=c('bill_name'='vote_id')) %>% 
  group_by(bill_name) %>% 
  mutate(abs_ideal=median(estimate),
         high_ideal=quantile(estimate,.95),
         low_ideal=quantile(estimate,.05),
         high_nom=mid.dim1 + 1.96*spread.dim1,
         low_nom=mid.dim1 - 1.96*spread.dim2) 
# 
# bills %>% distinct(bill_name,.keep_all=T) %>% 
#   gather(model_type,midpoint,estimate,mid.dim1) %>%
#   ggplot(aes(y=midpoint,x=reorder(bill_name,midpoint),colour=model_type,shape=model_type)) +
#     geom_pointrange(aes(ymin=position=position_dodge(width=0.3),
#                     size=0.15) + 
#     coord_flip() + theme_minimal() +
#     theme(panel.grid = element_blank()) +
#     xlab('Ideal Point Scores (Liberal to Conservative)') +
#     ylab('') +
#     scale_colour_brewer(palette='Accent',name="")
require(stargazer)
bills <-   group_by(bills,bill_num) %>% 
  summarize(m_abs_ideal=mean(abs_ideal),date=first(date),description=first(description))
bills %>% 
  arrange(m_abs_ideal) %>% slice(1:10) %>% 
  dplyr::select(description,date) %>% 
  write_csv('most_cons_bills.csv')

bills %>% 
  arrange(desc(m_abs_ideal)) %>% slice(1:10) %>% 
  dplyr::select(description,date) %>% 
  write_csv('most_lib_bills.csv')


# plot bills

highest_bill <- sort(bills$m_abs_ideal,decreasing=T,index.return=T)
lowest_bill <- sort(bills$m_abs_ideal,index.return=T)

id_plot(estimated_full,bill_plot=highest_bill$ix[2]) +
  scale_color_brewer(type='qual')
ggsave('con_discrim_bill.png',height=8.5,units='in')

# Now we need to do PRE

pscl_data <- dropRollCall(senate114,dropList=list(codes='notInLegis',lop=0,
                                                  legisMin=20))

keep_rows_nom <- which(is.na(wnominate_model$rollcalls$correctYea))
keep_rows_nom_car <- colnames(senate114$votes)[keep_rows_nom]
keep_rows_pscl <- pscl_data$dropInfo$votes
keep_rows_pscl <- which(keep_rows_pscl==F)
combined_drop <- c(keep_rows_nom,keep_rows_pscl)

  post_abs <- posterior_predict(estimated_full)
  
  pscl_person <- pscl_model$x[,,1]
  pscl_discrim <- pscl_model$beta[,,1]
  pscl_diff <- pscl_model$beta[,,2]
  
  post_pscl <- sapply(1:nrow(pscl_person), function(i) {
    outcome <-   t(as.matrix(pscl_discrim[i,]) %*% t(pscl_person[i,]))
    outcome <- sweep(outcome,2,pscl_diff[i,])
    if_else(plogis(c(outcome))>runif(length(outcome)),2L,1L)
    })
  
  
  
  calc_fp <- function(predicted,true,droprows=NULL,drop_o=T,reorder=NULL) {
  
    if(!is.null(droprows)) {
      true <- true[,-droprows]
    }
    if(drop_o==T) {
      true <- true[-1,]
    }
    if(!is.null(reorder)) {
      true <- true[reorder,]
    }
    true <- as.numeric(c(true))
    predicted==2 & true %in% c(4,5,6)
  }
  
  calc_fn <- function(predicted,true,droprows=NULL,drop_o=T,reorder=NULL) {
    if(!is.null(droprows)) {
      true <- true[,-droprows]
    }
    if(drop_o==T) {
      true <- true[-1,]
    }
    if(!is.null(reorder)) {
      true <- true[reorder,]
    }
    true <- as.numeric(c(true))
    predicted==1 & true %in% c(1,2,3)
  }
  
  fp_abs <- apply(post_abs,1,calc_fp,true=senate114$votes,
                  reorder=as.numeric(row.names(estimated_full@vote_data@vote_matrix)))
  fn_abs <- apply(post_abs,1,calc_fp,true=senate114$votes,
                  reorder=as.numeric(row.names(estimated_full@vote_data@vote_matrix)))
  fp_pscl <- apply(post_pscl,2,calc_fp,true=senate114$votes,
                   droprows=keep_rows_pscl)
  fn_pscl <- apply(post_pscl,2,calc_fp,true=senate114$votes,
                   droprows=keep_rows_pscl)
  pscl_data <- dropRollCall(senate114,dropList=list(codes='notInLegis',lop=0,
                                                    legisMin=20))
  drop_pscl <- colnames(pscl_data$votes)
  drop_pscl <- which(drop_pscl %in% keep_rows_nom_car)
  
  # need to drop WNOMINATE bills
  
  abs_bill_pts <- rep(1:ncol(idealdata@vote_matrix),each=nrow(idealdata@vote_matrix))
  abs_pers_pts <- rep(as.numeric(row.names(estimated_full@vote_data@vote_matrix)),times=ncol(idealdata@vote_matrix))
  pscl_bill_pts <- rep(1:pscl_model$m,each=pscl_model$n)
  pscl_pers_pts <- rep(1:pscl_model$n,times=pscl_model$m)
  
  fp_abs_by_sen <- bind_cols(data_frame(abs_pers_pts),as_data_frame(fp_abs)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,]) %in% c(4,5,6),1,0)) %>% 
    filter(!(abs_bill_pts %in% combined_drop)) %>% 
    gather(iter,value,-abs_pers_pts,-tot_neg) %>% 
    group_by(abs_pers_pts,iter) %>% 
    summarize(mean_fp_iter=sum(value)/sum(tot_neg)) %>%
    group_by(abs_pers_pts) %>% 
    summarize(mean_fp=mean(mean_fp_iter),
              sd_mean_fp=sd(mean_fp_iter)) %>% 
    mutate(legis_names=estimated_full@vote_data@legis_data$legis.names[unique(abs_pers_pts)]) %>% 
    arrange(mean_fp)
  
  fp_abs_by_bill <- bind_cols(data_frame(abs_bill_pts),as_data_frame(fp_abs)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,]) %in% c(4,5,6),1,0)) %>% 
    gather(iter,value,-abs_bill_pts,-tot_neg) %>% 
    group_by(abs_bill_pts,iter) %>% 
    summarize(mean_fp_iter=sum(value)/sum(tot_neg)) %>%
    group_by(abs_bill_pts) %>% 
    summarize(mean_fp=mean(mean_fp_iter),
              sd_mean_fp=sd(mean_fp_iter))
  
  fp_pscl_by_sen <- bind_cols(data_frame(pscl_pers_pts),as_data_frame(fp_pscl)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,-keep_rows_pscl]) %in% c(4,5,6),1,0)) %>% 
    filter(!(pscl_bill_pts %in% drop_pscl)) %>% 
    gather(iter,value,-pscl_pers_pts,-tot_neg) %>% 
    group_by(pscl_pers_pts,iter) %>% 
    summarize(mean_fp_iter=sum(value)/sum(tot_neg)) %>%
    group_by(pscl_pers_pts) %>% 
    summarize(mean_fp=mean(mean_fp_iter),
              sd_mean_fp=sd(mean_fp_iter)) %>% 
    mutate(legis_names=row.names(pscl_data$votes)) %>% 
    arrange(mean_fp)
  
  fp_pscl_by_bill <- bind_cols(data_frame(pscl_bill_pts),as_data_frame(fp_pscl)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,-keep_rows_pscl]) %in% c(4,5,6),1,0)) %>% 
    gather(iter,value,-pscl_bill_pts,-tot_neg) %>% 
    group_by(pscl_bill_pts,iter) %>% 
    summarize(mean_fp_iter=sum(value)/sum(tot_neg)) %>%
    group_by(pscl_bill_pts) %>% 
    summarize(mean_fp=mean(mean_fp_iter),
              sd_mean_fp=sd(mean_fp_iter))
  
  total_pos_sen <- bind_rows(list(`Absence-Inflated`=fp_abs_by_sen,
                                  `CJR`=fp_pscl_by_sen),.id='Model') %>% 
    group_by(Model) %>% 
    mutate(overall_mean=mean(mean_fp,na.rm=T))
  ggplot(total_pos_sen,aes(x=mean_fp)) +
    geom_density(aes(fill=Model),colour=NA,alpha=0.7,
                 adjust=.3) +
    theme_minimal() +
    theme(panel.grid=element_blank()) +
    scale_fill_discrete(name="Mean by Senator") +
    xlab('False Positive Rate') +
    ylab('Density') + 
    geom_vline(aes(xintercept=overall_mean,
                   linetype=Model)) + 
    scale_linetype(name='Pooled Mean')
  
  ggsave('false_positive_CJR_sen.png')
  
  fn_abs_by_sen <- bind_cols(data_frame(abs_pers_pts),as_data_frame(fn_abs)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,]) %in% c(1,2,3),1,0)) %>% 
    filter(!(abs_bill_pts %in% combined_drop)) %>% 
    gather(iter,value,-abs_pers_pts,-tot_neg) %>% 
    group_by(abs_pers_pts,iter) %>% 
    summarize(mean_fn_iter=sum(value)/sum(tot_neg)) %>%
    group_by(abs_pers_pts) %>% 
    summarize(mean_fn=mean(mean_fn_iter),
              sd_mean_fn=sd(mean_fn_iter)) %>% 
    mutate(legis_names=estimated_full@vote_data@legis_data$legis.names[unique(abs_pers_pts)]) %>% 
    arrange(mean_fn)
  
  fn_abs_by_bill <- bind_cols(data_frame(abs_bill_pts),as_data_frame(fn_abs)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,]) %in% c(1,2,3),1,0)) %>% 
    gather(iter,value,-abs_bill_pts,-tot_neg) %>% 
    group_by(abs_bill_pts,iter) %>% 
    summarize(mean_fn_iter=sum(value)/sum(tot_neg)) %>%
    group_by(abs_bill_pts) %>% 
    summarize(mean_fn=mean(mean_fn_iter),
              sd_mean_fn=sd(mean_fn_iter))
  
  fn_pscl_by_sen <- bind_cols(data_frame(pscl_pers_pts),as_data_frame(fn_pscl)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,-keep_rows_pscl]) %in% c(1,2,3),1,0)) %>% 
    filter(!(pscl_bill_pts %in% combined_drop)) %>% 
    gather(iter,value,-pscl_pers_pts,-tot_neg) %>% 
    group_by(pscl_pers_pts,iter) %>% 
    summarize(mean_fn_iter=sum(value)/sum(tot_neg)) %>%
    group_by(pscl_pers_pts) %>% 
    summarize(mean_fn=mean(mean_fn_iter),
              sd_mean_fn=sd(mean_fn_iter)) %>% 
    mutate(legis_names=row.names(pscl_data$votes)) %>% 
    arrange(mean_fn)
  
  fn_pscl_by_bill <- bind_cols(data_frame(pscl_bill_pts),as_data_frame(fn_pscl)) %>% 
    mutate(tot_neg=if_else(c(senate114$votes[-1,-keep_rows_pscl]) %in% c(1,2,3),1,0)) %>% 
    gather(iter,value,-pscl_bill_pts,-tot_neg) %>% 
    group_by(pscl_bill_pts,iter) %>% 
    summarize(mean_fn_iter=sum(value)/sum(tot_neg)) %>%
    group_by(pscl_bill_pts) %>% 
    summarize(mean_fn=mean(mean_fn_iter),
              sd_mean_fn=sd(mean_fn_iter)) 
  
  total_pos_sen <- bind_rows(list(`Absence-Inflated`=fn_abs_by_sen,
                                  `CJR`=fn_pscl_by_sen),.id='Model') %>% 
    group_by(Model) %>% 
    mutate(overall_mean=mean(mean_fn,na.rm=T),
           overall_median=median(mean_fn,na.rm=T))
  ggplot(total_pos_sen,aes(x=mean_fn)) +
    geom_density(aes(fill=Model),colour=NA,alpha=0.7,
                 adjust=.3) +
    theme_minimal() +
    theme(panel.grid=element_blank()) +
    scale_fill_discrete(name="Mean by Senator") +
    xlab('False Negative Rate') +
    ylab('Density') + 
    geom_vline(aes(xintercept=overall_mean,
                   linetype=Model)) + 
    scale_linetype(name='Pooled Mean')
  
  ggsave('false_negative_CJR_sen.png')
  
  
# Now let's also look at W-NOMINATE
  
fp_wnom_sen <- mutate(wnominate_model$legislators,
                     mean_fp=wrongYea/(wrongYea+correctNay))

total_pos_sen <- bind_rows(list(`W-NOMINATE`=fp_wnom_sen,
                                `Absence-Inflated`=fp_abs_by_sen),
                           .id='Model') %>% 
  group_by(Model) %>% 
  mutate(overall_mean=mean(mean_fp,na.rm=T))

ggplot(total_pos_sen,aes(x=mean_fp)) +
  geom_density(aes(fill=Model),colour=NA,alpha=0.7,
               adjust=.3) +
  theme_minimal() +
  theme(panel.grid=element_blank()) +
  scale_fill_discrete(name="Mean by Senator") +
  xlab('False Positive Rate') +
  ylab('Density') + 
  geom_vline(aes(xintercept=overall_mean,
                 linetype=Model)) + 
  scale_linetype(name='Pooled Mean')

ggsave('false_positive_WN_sen.png')
  

fn_wnom_sen <- mutate(wnominate_model$legislators,
                      mean_fn=wrongNay/(wrongNay+correctYea))

total_pos_sen <- bind_rows(list(`W-NOMINATE`=fn_wnom_sen,
                                `Absence-Inflated`=fn_abs_by_sen),
                           .id='Model') %>% 
  group_by(Model) %>% 
  mutate(overall_mean=mean(mean_fn,na.rm=T))

ggplot(total_pos_sen,aes(x=mean_fn)) +
  geom_density(aes(fill=Model),colour=NA,alpha=0.7,
               adjust=.3) +
  theme_minimal() +
  theme(panel.grid=element_blank()) +
  scale_fill_discrete(name="Mean by Senator") +
  xlab('False Negative Rate') +
  ylab('Density') + 
  geom_vline(aes(xintercept=overall_mean,
                 linetype=Model)) + 
  scale_linetype(name='Pooled Mean')

ggsave('false_negative_WN_sen.png')

